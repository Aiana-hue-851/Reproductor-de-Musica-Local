<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cassette Calendar — Reproductor Local</title>
<style>
  :root{
    --bg: #121210;
    --cassette-body: #e6caa7;
    --cassette-trim: #7b3f2f;
    --accent: #d94f3b;
    --text: #111;
    --panel-bg: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.06);
  }

  /* Reset básico */
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,var(--bg),#0d0d0d);
    color: #fff;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
  }

  /* Contenedor principal */
  .app{
    width:min(1200px, 96vw);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));
    border-radius:18px;
    padding:20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    display:grid;
    grid-template-columns: 480px 1fr;
    gap:20px;
    align-items:start;
  }

  /* CASSSETTE VISUAL */
  .cassette{
    background: linear-gradient(180deg,var(--cassette-body), #d8bfa3);
    border-radius:12px;
    padding:18px;
    position:relative;
    box-shadow: inset 0 2px 0 rgba(255,255,255,0.12), 0 6px 18px rgba(0,0,0,0.6);
    border:4px solid var(--cassette-trim);
    min-height:320px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .cassette .label{
    background:var(--panel-bg);
    border-radius:8px;
    padding:10px;
    text-align:center;
    font-weight:700;
    color:var(--text);
    letter-spacing:1px;
  }

  .cassette .reels{
    display:flex;
    gap:20px;
    justify-content:center;
    align-items:center;
    padding:12px 0;
  }

  .reel{
    width:110px;
    height:110px;
    border-radius:50%;
    background:radial-gradient(circle at 35% 30%, rgba(255,255,255,0.12), transparent 12%),
               linear-gradient(180deg, rgba(0,0,0,0.2), rgba(0,0,0,0.6));
    border:8px solid rgba(0,0,0,0.4);
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    box-shadow: inset 0 4px 10px rgba(255,255,255,0.03);
  }

  /* Círculo interior */
  .reel .hub{
    width:48%;
    height:48%;
    border-radius:50%;
    background:linear-gradient(180deg,#111,#333);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    transform-origin:center;
    /* animación por defecto pausada */
    animation: spin 3.5s linear infinite paused;
  }

  /* Efecto cinta (línea translúcida) */
  .tape {
    position:absolute;
    left:10%;
    right:10%;
    height:18px;
    top:48%;
    transform:translateY(-50%);
    background: repeating-linear-gradient(90deg, rgba(0,0,0,0.15) 0 6px, rgba(255,255,255,0.02) 6px 12px);
    border-radius:6px;
    box-shadow: inset 0 2px rgba(0,0,0,0.2);
  }

  /* Recontainer para botones */
  .controls{
    display:flex;
    gap:12px;
    justify-content:center;
    align-items:center;
    margin-top:auto;
    padding-top:6px;
  }

  .btn{
    background:var(--accent);
    border:none;
    padding:12px 18px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    color:white;
    box-shadow:0 6px 14px rgba(0,0,0,0.45);
    user-select:none;
  }

  .btn.alt{
    background:var(--cassette-trim);
  }

  .small{
    padding:8px 12px;
    font-size:0.92rem;
  }

  /* Right panel: calendario + reproductor */
  .panel{
    background: rgba(255,255,255,0.02);
    padding:14px;
    border-radius:12px;
    min-height:320px;
  }

  /* Header del panel */
  .panel .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:10px;
  }

  .panel h2{ margin:0; font-size:1.25rem; letter-spacing:0.6px;}
  .panel .month-nav{ display:flex; gap:8px; align-items:center; }

  /* Calendario */
  .calendar{
    width:100%;
    background:var(--glass);
    padding:12px;
    border-radius:10px;
  }

  .weekdays{
    display:grid;
    grid-template-columns: repeat(7,1fr);
    gap:6px;
    font-weight:700;
    font-size:0.85rem;
    margin-bottom:8px;
  }

  .days{
    display:grid;
    grid-template-columns: repeat(7,1fr);
    gap:8px;
  }

  .day{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
    padding:8px;
    min-height:80px;
    border-radius:8px;
    position:relative;
    display:flex;
    flex-direction:column;
    gap:8px;
    transition:transform .18s ease, box-shadow .18s;
    cursor:pointer;
    overflow:hidden;
  }

  .day:hover{
    transform: translateY(-6px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }

  .day .date-num{
    font-weight:700;
    color:var(--text);
    background:rgba(255,255,255,0.06);
    padding:4px 8px;
    border-radius:6px;
    width:max-content;
    font-size:0.9rem;
  }

  .day .tracks{
    font-size:0.85rem;
    color:rgba(0,0,0,0.8);
    background:rgba(255,255,255,0.05);
    padding:6px;
    border-radius:6px;
    flex:1;
    overflow:auto;
  }

  .day .badge{
    position:absolute;
    right:8px;
    top:8px;
    background:var(--accent);
    color:white;
    padding:4px 8px;
    border-radius:8px;
    font-weight:700;
    font-size:0.75rem;
  }

  /* Modal */
  .modal{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background: rgba(0,0,0,0.6);
    z-index:60;
  }

  .modal.show{ display:flex; }

  .modal .card{
    width:min(720px, 92vw);
    max-height:86vh;
    background:linear-gradient(180deg,#ffffff07,#0000000f);
    border-radius:12px;
    padding:16px;
    overflow:auto;
  }

  .file-list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }

  .track-row{
    display:flex;
    gap:10px;
    align-items:center;
    background:rgba(255,255,255,0.02);
    padding:8px;
    border-radius:8px;
    justify-content:space-between;
  }

  .player{
    margin-top:12px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
  }

  .player .icon{ font-weight:800; font-size:1.2rem; }

  /* Small screens layout */
  @media (max-width:900px){
    .app{ grid-template-columns:1fr; padding:12px; }
    .cassette{ order:2; }
    .panel{ order:1; }
  }

  @media (max-width:520px){
    .reel{ width:78px; height:78px; border-width:6px;}
    .reel .hub{ width:46%; height:46%; }
    .day{ min-height:68px; padding:6px; }
  }

  /* Animations */
  @keyframes spin{
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* overlay pedir rotación */
  .rotate-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    color:white;
    display:none;
    align-items:center;
    justify-content:center;
    text-align:center;
    z-index:80;
    padding:20px;
  }
  .rotate-overlay.show{ display:flex; }

  .rotate-overlay .box{
    max-width:420px;
    border-radius:12px;
    padding:22px;
    background: rgba(255,255,255,0.02);
    font-size:1.1rem;
  }

  /* tiny helper */
  .muted{ opacity:.8; font-size:.95rem; color: rgba(255,255,255,0.9); }

</style>
</head>
<body>
  <div class="app" id="app">

    <!-- Cassette Visual Left -->
    <div class="cassette" id="cassette">
      <div class="label">CASSETTE CALENDAR</div>

      <div class="reels" id="reelsWrap">
        <div class="reel" id="reelLeft" title="Reel izquierdo">
          <div class="hub" id="hubLeft">◐</div>
        </div>

        <div class="tape" id="tapeVisual"></div>

        <div class="reel" id="reelRight" title="Reel derecho">
          <div class="hub" id="hubRight">◑</div>
        </div>
      </div>

      <div style="text-align:center; color: rgba(0,0,0,0.75); font-weight:700;">
        Estética Retro · Música local · Calendario
      </div>

      <div class="controls">
        <button class="btn" id="btnOpen">Abrir</button>
        <button class="btn alt" id="btnRepair">Reparar</button>
        <button class="btn small" id="btnLockOrientation">Forzar horizontal (móvil)</button>
      </div>
    </div>

    <!-- Right Panel -->
    <div class="panel">
      <div class="header">
        <h2 id="monthTitle">Calendario</h2>
        <div class="month-nav">
          <button class="btn small" id="prevMonth">◀</button>
          <button class="btn small" id="nextMonth">▶</button>
        </div>
      </div>

      <div class="calendar" id="calendarWrap" aria-hidden="true">
        <div class="weekdays" id="weekdays"></div>
        <div class="days" id="days"></div>
      </div>

      <div style="margin-top:12px;">
        <div class="muted">Controles globales:</div>
        <div class="player" id="globalPlayer">
          <button class="btn small" id="prevTrack">⟨⟨</button>
          <button class="btn small" id="playPause">Play</button>
          <button class="btn small" id="nextTrack">⟩⟩</button>
          <div id="currentTrackName" style="min-width:180px; text-align:center; font-weight:700; color:var(--text); background:rgba(255,255,255,0.03); padding:8px; border-radius:8px;">Sin pista</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal para gestionar canciones de un día -->
  <div class="modal" id="modal">
    <div class="card">
      <h3 id="modalTitle">Día</h3>
      <p class="muted">Sube archivos de audio desde tu dispositivo. Se reproducen localmente (no suben a servidor).</p>
      <input type="file" id="fileInput" accept="audio/*" multiple />
      <div class="file-list" id="fileList"></div>
      <div style="margin-top:12px; text-align:right;">
        <button class="btn alt" id="closeModal">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- overlay pedir rotacion -->
  <div class="rotate-overlay" id="rotateOverlay">
    <div class="box">
      <div style="font-weight:800; font-size:1.2rem; margin-bottom:8px;">Gira tu dispositivo</div>
      <div class="muted">Para una mejor experiencia, por favor gira tu móvil a modo horizontal (landscape).</div>
      <div style="margin-top:12px;">
        <button class="btn" id="btnIveRotated">Ya giré</button>
      </div>
    </div>
  </div>

<script>
/* --------------- LÓGICA PRINCIPAL --------------- */
/*
 Estructura de datos:
  playlists: Map( dateKey -> [{file, url, name, duration?}] )
  currentDateKey: día seleccionado
  currentIndex: índice en la lista del día
*/

const playlists = new Map();
let currentDateKey = null;
let currentIndex = 0;
let audio = new Audio();
audio.preload = "metadata";
let isPlaying = false;

/* UI refs */
const daysEl = document.getElementById('days');
const monthTitle = document.getElementById('monthTitle');
const weekdaysEl = document.getElementById('weekdays');
const modal = document.getElementById('modal');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const modalTitle = document.getElementById('modalTitle');
const calendarWrap = document.getElementById('calendarWrap');

const reelLeftHub = document.getElementById('hubLeft');
const reelRightHub = document.getElementById('hubRight');
const btnOpen = document.getElementById('btnOpen');
const btnRepair = document.getElementById('btnRepair');
const btnLockOrientation = document.getElementById('btnLockOrientation');
const rotateOverlay = document.getElementById('rotateOverlay');
const btnIveRotated = document.getElementById('btnIveRotated');

const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');

const playPauseBtn = document.getElementById('playPause');
const prevTrackBtn = document.getElementById('prevTrack');
const nextTrackBtn = document.getElementById('nextTrack');
const currentTrackName = document.getElementById('currentTrackName');

let viewYear, viewMonth; // month = 0..11

/* Inicializamos calendario en mes actual */
const today = new Date();
viewYear = today.getFullYear();
viewMonth = today.getMonth();

/* RENDER WEEKDAYS - ensure week starts Monday */
const weekdayNames = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
function renderWeekdays(){
  weekdaysEl.innerHTML = '';
  for(const wd of weekdayNames){
    const el = document.createElement('div');
    el.textContent = wd;
    weekdaysEl.appendChild(el);
  }
}
renderWeekdays();

/* Generar calendario para viewYear/viewMonth */
function renderCalendar(){
  monthTitle.textContent = new Date(viewYear, viewMonth).toLocaleString('es-ES',{month:'long', year:'numeric'});
  daysEl.innerHTML = '';

  // Primer día del mes (0=domingo) -> queremos semanas que empiecen LUNES
  const firstOfMonth = new Date(viewYear, viewMonth, 1);
  // convertimos a weekday index donde 0 = Monday
  const offset = (firstOfMonth.getDay() + 6) % 7; // si firstOfMonth.getDay() es 1 (lunes), offset 0
  const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();

  // previous month's tail: no lo mostramos, simplemente dejamos espacios
  for(let i=0;i<offset;i++){
    const spacer = document.createElement('div');
    spacer.className = 'day';
    spacer.style.background = 'transparent';
    spacer.style.boxShadow = 'none';
    spacer.style.cursor = 'default';
    daysEl.appendChild(spacer);
  }

  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(viewYear, viewMonth, d);
    const key = dateKeyFromDate(date);
    const dayEl = document.createElement('div');
    dayEl.className = 'day';
    dayEl.dataset.dateKey = key;

    const dateNum = document.createElement('div');
    dateNum.className = 'date-num';
    dateNum.textContent = d;
    dayEl.appendChild(dateNum);

    const badge = document.createElement('div');
    badge.className = 'badge';
    badge.style.display = 'none';
    badge.textContent = '0';
    dayEl.appendChild(badge);

    const tracks = document.createElement('div');
    tracks.className = 'tracks';
    tracks.textContent = 'Sin pistas';
    dayEl.appendChild(tracks);

    // Hover: show tape spin visual by toggling reel animation
    dayEl.addEventListener('mouseenter', ()=>{
      // añadir animación girando visual - no inicia reproducción
      reelLeftHub.style.animationPlayState = 'running';
      reelRightHub.style.animationPlayState = 'running';
      // opcional: añadir una pequeña aceleración
      reelLeftHub.style.animationDuration = '1.8s';
      reelRightHub.style.animationDuration = '1.8s';
    });
    dayEl.addEventListener('mouseleave', ()=>{
      // solo parar si nada se reproduce
      if(!isPlaying) {
        reelLeftHub.style.animationPlayState = 'paused';
        reelRightHub.style.animationPlayState = 'paused';
        reelLeftHub.style.animationDuration = '3.5s';
        reelRightHub.style.animationDuration = '3.5s';
      } else {
        // si se está reproduciendo volver a velocidad normal
        reelLeftHub.style.animationDuration = '3.5s';
        reelRightHub.style.animationDuration = '3.5s';
      }
    });

    // click -> abrir modal para subir/ver pistas del día
    dayEl.addEventListener('click', ()=> openDayModal(key, dayEl));

    // mostrar resumen si ya hay pistas
    if(playlists.has(key) && playlists.get(key).length>0){
      const arr = playlists.get(key);
      badge.style.display = 'block';
      badge.textContent = arr.length;
      tracks.textContent = arr.map((t,i)=> (i+1)+'. '+t.name).join('\n');
    }

    daysEl.appendChild(dayEl);
  }
}

/* Helpers */
function dateKeyFromDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

/* Modal: abrir día */
function openDayModal(key, dayEl){
  currentDateKey = key;
  modalTitle.textContent = `Día ${key}`;
  modal.classList.add('show');
  fileList.innerHTML = '';

  // populate existing
  const list = playlists.get(key) || [];
  if(list.length === 0){
    fileList.innerHTML = '<div class="muted">No hay pistas. Usa el selector para añadir archivos locales.</div>';
  } else {
    for(let i=0;i<list.length;i++){
      const t = list[i];
      const row = makeTrackRow(t, i);
      fileList.appendChild(row);
    }
  }
}

/* Cerrar modal */
document.getElementById('closeModal').addEventListener('click', ()=>{
  modal.classList.remove('show');
});

/* File input handler */
fileInput.addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files || []);
  if(!files.length) return;
  if(!currentDateKey) currentDateKey = dateKeyFromDate(new Date());
  if(!playlists.has(currentDateKey)) playlists.set(currentDateKey, []);
  const arr = playlists.get(currentDateKey);

  for(const file of files){
    const url = URL.createObjectURL(file);
    const track = { file, url, name: file.name };
    arr.push(track);
    const idx = arr.length - 1;
    const row = makeTrackRow(track, idx);
    fileList.appendChild(row);
  }

  // refresh calendar day summary badges
  renderCalendar();
  // clear input to allow reuploading same file name if desired
  fileInput.value = '';
});

/* Crear fila de track en modal */
function makeTrackRow(track, idx){
  const row = document.createElement('div');
  row.className = 'track-row';
  const left = document.createElement('div');
  left.style.display='flex';
  left.style.flexDirection='column';
  left.style.gap='4px';
  const name = document.createElement('div');
  name.textContent = track.name;
  name.style.fontWeight='700';
  const hint = document.createElement('div');
  hint.className = 'muted';
  hint.style.fontSize='0.85rem';
  hint.textContent = 'Archivo local';
  left.appendChild(name);
  left.appendChild(hint);

  const right = document.createElement('div');
  right.style.display='flex';
  right.style.gap='8px';
  const playBtn = document.createElement('button');
  playBtn.className = 'btn small';
  playBtn.textContent = '▶';
  playBtn.addEventListener('click', ()=>{
    // reproducir inmediatamente esta pista en el contexto del día
    const list = playlists.get(currentDateKey) || [];
    currentIndex = idx;
    playFromCurrentList(list);
    modal.classList.remove('show');
  });

  const delBtn = document.createElement('button');
  delBtn.className = 'btn small alt';
  delBtn.textContent = 'Eliminar';
  delBtn.addEventListener('click', ()=>{
    // eliminar track
    const list = playlists.get(currentDateKey) || [];
    list.splice(idx,1);
    // revoke url
    try{ URL.revokeObjectURL(track.url); }catch(e){}
    renderCalendar();
    // recargar modal contents
    openDayModal(currentDateKey);
  });

  right.appendChild(playBtn);
  right.appendChild(delBtn);

  row.appendChild(left);
  row.appendChild(right);
  return row;
}

/* Reproductor global: play a partir de la lista actual */
function playFromCurrentList(list){
  if(!list || list.length === 0){
    currentTrackName.textContent = 'Sin pista';
    return;
  }
  if(currentIndex < 0) currentIndex = 0;
  if(currentIndex >= list.length) currentIndex = 0;
  const track = list[currentIndex];
  audio.src = track.url;
  audio.play().then(()=>{
    isPlaying = true;
    reelLeftHub.style.animationPlayState = 'running';
    reelRightHub.style.animationPlayState = 'running';
    playPauseBtn.textContent = 'Pausa';
    currentTrackName.textContent = track.name;
  }).catch(err=>{
    console.error('No se pudo reproducir', err);
    isPlaying = false;
  });
}

/* Play/pause toggle */
playPauseBtn.addEventListener('click', ()=>{
  if(!audio.src){
    // intentar cargar desde la selección actual del día
    const list = playlists.get(currentDateKey) || [];
    if(list && list.length) {
      playFromCurrentList(list);
      modal.classList.remove('show');
    } else {
      alert('No hay pistas seleccionadas. Abre un día y añade pistas.');
      return;
    }
  } else {
    if(audio.paused){
      audio.play();
      isPlaying = true;
      reelLeftHub.style.animationPlayState = 'running';
      reelRightHub.style.animationPlayState = 'running';
      playPauseBtn.textContent = 'Pausa';
    } else {
      audio.pause();
      isPlaying = false;
      // detener reel visual (si no hovered)
      reelLeftHub.style.animationPlayState = 'paused';
      reelRightHub.style.animationPlayState = 'paused';
      playPauseBtn.textContent = 'Play';
    }
  }
});

prevTrackBtn.addEventListener('click', ()=>{
  const list = playlists.get(currentDateKey) || [];
  if(!list || list.length===0) return;
  currentIndex = (currentIndex - 1 + list.length) % list.length;
  playFromCurrentList(list);
});

nextTrackBtn.addEventListener('click', ()=>{
  const list = playlists.get(currentDateKey) || [];
  if(!list || list.length===0) return;
  currentIndex = (currentIndex + 1) % list.length;
  playFromCurrentList(list);
});

/* Cuando termina la pista, pasar a siguiente */
audio.addEventListener('ended', ()=>{
  const list = playlists.get(currentDateKey) || [];
  if(list && list.length>0){
    currentIndex = (currentIndex + 1) % list.length;
    playFromCurrentList(list);
  } else {
    isPlaying = false;
    reelLeftHub.style.animationPlayState = 'paused';
    reelRightHub.style.animationPlayState = 'paused';
    playPauseBtn.textContent = 'Play';
  }
});

/* Botón Abrir: mostrar/ocultar calendario (ya visible) - pero lo usamos para forzar interacción y rotación intento */
btnOpen.addEventListener('click', async ()=>{
  // togglear visibilidad del calendario
  const hidden = calendarWrap.getAttribute('aria-hidden') === 'true';
  calendarWrap.setAttribute('aria-hidden', hidden ? 'false' : 'true');
  if(hidden) calendarWrap.style.display = 'block'; else calendarWrap.style.display = 'none';

  // Intentar forzar orientación (necesita user gesture).
  await tryLockLandscape();
});

/* BOTÓN REPARAR: Cambia colores y reinicia animación de cinta sin borrar pistas */
btnRepair.addEventListener('click', ()=>{
  // cambiar paleta: elegir aleatorio entre presets
  const palettes = [
    {body:'#e6caa7', trim:'#7b3f2f', accent:'#d94f3b', text:'#111'},
    {body:'#bfe7ff', trim:'#03396c', accent:'#ff7f50', text:'#031427'},
    {body:'#d8c7ff', trim:'#5a2d6e', accent:'#ffcd3c', text:'#1c0836'},
    {body:'#fce4d6', trim:'#6b4a2a', accent:'#ff6b6b', text:'#22110d'},
    {body:'#e8ffd6', trim:'#2e6b2e', accent:'#4f8f8f', text:'#071207'}
  ];
  const p = palettes[Math.floor(Math.random()*palettes.length)];
  document.documentElement.style.setProperty('--cassette-body', p.body);
  document.documentElement.style.setProperty('--cassette-trim', p.trim);
  document.documentElement.style.setProperty('--accent', p.accent);
  document.documentElement.style.setProperty('--text', p.text);

  // reiniciar animación de las bobinas (reflow trick)
  resetReelAnimation();

  // intentar rotación también por interacción
  tryLockLandscape();
});

/* reiniciar animacion: quitar y volver a añadir animación para que empiece desde cero */
function resetReelAnimation(){
  // stop, force reflow, restart
  reelLeftHub.style.animation = 'none';
  reelRightHub.style.animation = 'none';
  // small timeout to force reflow
  setTimeout(()=>{
    reelLeftHub.style.animation = 'spin 3.5s linear infinite';
    reelRightHub.style.animation = 'spin 3.5s linear infinite';
    // si no hay reproducción, pausar hasta hovering
    if(!isPlaying){
      reelLeftHub.style.animationPlayState = 'paused';
      reelRightHub.style.animationPlayState = 'paused';
    } else {
      reelLeftHub.style.animationPlayState = 'running';
      reelRightHub.style.animationPlayState = 'running';
    }
  },60);
}

/* Inicialmente definimos la animación pero pausada */
resetReelAnimation();

/* mes nav */
prevMonth.addEventListener('click', ()=>{
  viewMonth--;
  if(viewMonth<0){ viewMonth=11; viewYear--; }
  renderCalendar();
});
nextMonth.addEventListener('click', ()=>{
  viewMonth++;
  if(viewMonth>11){ viewMonth=0; viewYear++; }
  renderCalendar();
});

/* OPEN modal por defecto desde boton Abrir? El botón ya intenta mostrar calendar. También añadimos doble acceso: click en día abre modal */
/* Render inicial */
renderCalendar();

/* Intento de bloqueo de orientación horizontal (se ejecuta en contexto de interacción) */
async function tryLockLandscape(){
  if(!('orientation' in screen) || !screen.orientation || !screen.orientation.lock) {
    // fallback: mostrar overlay pidiendo girar
    showRotateOverlay();
    return;
  }
  try{
    // algunos navegadores requieren modo fullscreen; intentamos sin fullscreen primero
    await screen.orientation.lock('landscape');
    hideRotateOverlay();
    console.log('Lock orientation requested: landscape');
  }catch(err){
    console.warn('No se pudo forzar orientación: ', err);
    showRotateOverlay();
  }
}

/* Overlay show/hide */
function showRotateOverlay(){
  rotateOverlay.classList.add('show');
}
function hideRotateOverlay(){
  rotateOverlay.classList.remove('show');
}
btnIveRotated.addEventListener('click', ()=> hideRotateOverlay());
btnLockOrientation.addEventListener('click', ()=> tryLockLandscape());

/* Mejora: al detectar orientación actual en vertical, mostrar overlay automáticamente en mobiles */
function checkAutoOverlay(){
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);
  if(!isMobile) return;
  // if orientation is portrait show overlay
  if(window.innerHeight > window.innerWidth){
    showRotateOverlay();
  } else {
    hideRotateOverlay();
  }
}
window.addEventListener('resize', checkAutoOverlay);
checkAutoOverlay();

/* Al cerrar modal actualizar resumen */
modal.addEventListener('transitionend', ()=> renderCalendar());
document.getElementById('closeModal').addEventListener('click', ()=> renderCalendar());

/* Evitar arrastre de ficheros por fuera del input rompiendo la página */
window.addEventListener('dragover', e=> e.preventDefault());
window.addEventListener('drop', e=> e.preventDefault());

/* Guardar current playlist index globalmente al reproducir manualmente desde modal */
audio.addEventListener('play', ()=> { isPlaying = true; playPauseBtn.textContent = 'Pausa'; });
audio.addEventListener('pause', ()=> { isPlaying = false; playPauseBtn.textContent = 'Play'; });

/* Extras: si el usuario cierra la pestaña, no perdemos nada porque todo está en memoria por ahora (no persistimos) */
/* Si deseas persistir, podríamos usar IndexedDB en otra iteración. */

</script>
</body>
</html>
